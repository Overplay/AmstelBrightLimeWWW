app.controller("waitlistController",["$scope","$interval","$timeout","$http","$log","$location","optvModel",function($scope,$interval,$timeout,$http,$log,$location,optvModel){$log.info("Loading waitlistController");$scope.addErrors={name:false,partySize:false,nameExists:function(){return partiesContainName($scope.newParty.name)}};$scope.$watch(function(){return $scope.newParty.name},function(newVal){if($scope.addErrors.name&&newVal.length>0)$scope.addErrors.name=false});$scope.$watch(function(){return $scope.newParty.partySize},function(newVal){if($scope.addErrors.partySize&&newVal.length>0)$scope.addErrors.partySize=false});$scope.parties=function(){return optvModel.model.parties};function retrieveData(data){console.log("Data Callback! - control",data);optvModel.model.parties=data.parties}function sendTextToParty(party){var phone=party.phone;console.log("Sending text alert to",phone,"...")}var CHECK_INTERVAL=1e3;var WAIT_TIME_BEFORE_SEND=20;function checkAndSendTextAlert(){var currentDate=new Date;for(var i in $scope.parties()){var party=$scope.parties()[i];if(!party.phone||party.alreadySent)continue;if((currentDate-party.dateCreated)/1e3/60>=WAIT_TIME_BEFORE_SEND){sendTextToParty(party);party.phone=false}}$interval(checkAndSendTextAlert,CHECK_INTERVAL)}function initialize(){optvModel.init({appName:"io.ourglass.waitinglist",initialValue:{parties:[{name:"Noah",partySize:5,dateCreated:new Date((new Date).valueOf()-6e4*20),phone:"4084990902",showOptions:true}]},dataCallback:retrieveData});checkAndSendTextAlert();emptyNewParty()}function emptyNewParty(){$scope.newParty={name:"",partySize:undefined,dateCreated:undefined,phone:undefined,showOptions:false}}function partiesContainName(name){for(var i in $scope.parties()){var arrParty=$scope.parties()[i];if(arrParty.name==name)return true}return false}$scope.cancel=function(){$location.path("/home");emptyNewParty()};$scope.add=function(){if($scope.newParty.name&&$scope.newParty.partySize){$scope.newParty.name.trim();if(partiesContainName($scope.newParty.name)){$scope.addErrors.nameExists=true}else{$scope.newParty.dateCreated=new Date;optvModel.model.parties.push($scope.newParty);optvModel.save();$scope.cancel()}}else{if(!$scope.newParty.name)$scope.addErrors.name=true;if(!$scope.newParty.partySize)$scope.addErrors.partySize=true;console.log($scope.addErrors)}};$scope.openAdd=function(){emptyNewParty();$location.path("/add")};function partiesAreEqual(party1,party2){return party1.name==party2.name}function indexOfParty(party){for(var i=0;i<optvModel.model.parties.length;i++){var arrParty=optvModel.model.parties[i];if(partiesAreEqual(arrParty,party)){return i}}return-1}function removeParty(party){var index=indexOfParty(party);if(index==-1){console.log("I could not find",party,"in",optvModel.model.parties)}else{optvModel.model.parties.splice(index,1);optvModel.save()}}$scope.applyBorderBack=function(element){console.log("applyBorderBack",element);angular.element(element).removeClass("party-elongated")};$scope.doPartyBnAction=function(party,$event){var label=$event.target.innerHTML;console.log(label)};$scope.toggleOptions=function(party,$event){party.showOptions=!party.showOptions;if(party.showOptions){angular.element($event.target).addClass("party-elongated")}else{}};initialize()}]);app.directive("phoneInput",function($filter,$browser){return{require:"ngModel",restrict:"A",link:function($scope,$element,$attrs,ngModelCtrl){var listener=function(){var value=$element.val().replace(/[^0-9]/g,"");$element.val($filter("tel")(value,false))};ngModelCtrl.$parsers.push(function(viewValue){return viewValue.replace(/[^0-9]/g,"").slice(0,10)});ngModelCtrl.$render=function(){$element.val($filter("tel")(ngModelCtrl.$viewValue,false))};$element.bind("change",listener);$element.bind("keydown",function(event){var key=event.keyCode;if(key==91||15<key&&key<19||37<=key&&key<=40){return}$browser.defer(listener)});$element.bind("paste cut",function(){$browser.defer(listener)})}}});app.filter("tel",function(){var lastValueLength=0;return function(tel){if(!tel){return""}var value=tel.toString().trim().replace(/^\+/,"");if(value.match(/[^0-9]/)){return tel}var country,city,number;switch(value.length){case 1:case 2:case 3:city=value;break;default:city=value.slice(0,3);number=value.slice(3)}var lastValue=lastValueLength;lastValueLength=value.length;if(number){if(number.length>3){number=number.slice(0,3)+"-"+number.slice(3,7)}else{number=number}return("("+city+") "+number).trim()}else if(value.length==3&&lastValue==2){return"("+city+")"}else{return"("+city}}});app.directive("nsTransitionEnd",function(){return{restrict:"A",scope:{nsTransitionEnd:"&",party:"="},link:function(scope,element,attrs){element.bind("transitionend",function(e){scope.$apply(function(){if(!scope.party.showOptions){angular.element(e.target).removeClass("party-elongated")}else{console.log(angular.element(e.target).querySelector(".party-options"))}})})}}});